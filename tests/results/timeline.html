<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Execution Timeline - Temporal Analysis</title>

    <!-- D3.js for Timeline -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- Chart.js for Trend Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Date Range Picker -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e1e2e 0%, #2d2d44 100%);
            color: #e0e0e0;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
        }

        .header h1 {
            color: white;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .breadcrumb {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.95em;
        }

        .breadcrumb a {
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            transition: color 0.3s;
        }

        .breadcrumb a:hover {
            color: white;
            text-decoration: underline;
        }

        /* Statistics Cards */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s;
        }

        .stat-card:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .stat-label {
            font-size: 0.85em;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: #6366f1;
        }

        .stat-subtext {
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 5px;
        }

        /* Controls Panel */
        .controls-panel {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .controls-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-label {
            font-size: 0.85em;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        select, button, input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #e0e0e0;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.3s;
        }

        select:hover, button:hover, input:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }

        button {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border: none;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button:hover {
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(99, 102, 241, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        /* Timeline Container */
        .timeline-container {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            overflow-x: auto;
        }

        #timeline-svg {
            background: linear-gradient(180deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
            border-radius: 8px;
        }

        /* Chart Containers */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
        }

        .chart-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #e0e0e0;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(99, 102, 241, 0.3);
        }

        /* Event Log Table */
        .event-log-container {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: rgba(99, 102, 241, 0.2);
            color: #e0e0e0;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 0.5px;
            border-bottom: 2px solid rgba(99, 102, 241, 0.5);
        }

        td {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9em;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.03);
            cursor: pointer;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-completed {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        .status-failed {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        /* Tooltip */
        .tooltip {
            position: absolute;
            background: rgba(30, 30, 46, 0.95);
            border: 1px solid rgba(99, 102, 241, 0.5);
            border-radius: 8px;
            padding: 15px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            max-width: 350px;
        }

        .tooltip-title {
            font-weight: 700;
            color: #6366f1;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .tooltip-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .tooltip-label {
            color: rgba(255, 255, 255, 0.6);
        }

        .tooltip-value {
            color: #e0e0e0;
            font-weight: 600;
        }

        /* Comparison Panel */
        .comparison-panel {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(99, 102, 241, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .comparison-panel.active {
            display: block;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            margin-top: 15px;
        }

        .comparison-card {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 8px;
            padding: 15px;
        }

        .comparison-divider {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            color: rgba(255, 255, 255, 0.3);
        }

        /* Timeline Markers */
        .timeline-marker {
            cursor: pointer;
            transition: all 0.3s;
        }

        .timeline-marker:hover {
            stroke: #6366f1;
            stroke-width: 3;
        }

        .timeline-marker.selected {
            stroke: #8b5cf6;
            stroke-width: 4;
        }

        /* Annotations */
        .annotation-line {
            stroke: rgba(239, 68, 68, 0.6);
            stroke-width: 2;
            stroke-dasharray: 5,5;
        }

        .annotation-text {
            fill: #f87171;
            font-size: 11px;
            font-weight: 600;
        }

        /* Navigation Component */
        .nav-container {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px 25px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .nav-links {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .nav-link {
            color: #e0e0e0;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.95em;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-link:hover {
            background: rgba(99, 102, 241, 0.2);
            border-color: rgba(99, 102, 241, 0.4);
            color: #ffffff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .nav-link.active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border-color: transparent;
            color: white;
            font-weight: 600;
        }

        .nav-breadcrumb {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-breadcrumb a {
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            transition: color 0.3s;
        }

        .nav-breadcrumb a:hover {
            color: #6366f1;
        }

        .nav-breadcrumb-separator {
            color: rgba(255, 255, 255, 0.4);
            font-size: 0.8em;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .stats-container {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .comparison-grid {
                grid-template-columns: 1fr;
            }

            .comparison-divider {
                display: none;
            }

            .nav-container {
                flex-direction: column;
                align-items: flex-start;
            }

            .nav-links {
                width: 100%;
                flex-direction: column;
                gap: 10px;
            }

            .nav-link {
                width: 100%;
                justify-content: center;
            }
        }

        /* Axis styling */
        .axis text {
            fill: rgba(255, 255, 255, 0.7);
            font-size: 12px;
        }

        .axis line, .axis path {
            stroke: rgba(255, 255, 255, 0.2);
        }

        .grid line {
            stroke: rgba(255, 255, 255, 0.1);
            stroke-dasharray: 3,3;
        }
    </style>
</head>
<body>
    <!-- Navigation Component -->
    <nav class="nav-container">
        <div class="nav-breadcrumb">
            <a href="dashboard.html">🏠 Home</a>
            <span class="nav-breadcrumb-separator">›</span>
            <span>Timeline Analysis</span>
        </div>
        <div class="nav-links">
            <a href="dashboard.html" class="nav-link">
                📊 Dashboard
            </a>
            <a href="timeline.html" class="nav-link active">
                📈 Timeline
            </a>
            <a href="comparison.html" class="nav-link">
                ⚖️ Comparison
            </a>
            <a href="metrics.html" class="nav-link">
                📉 Metrics
            </a>
            <a href="entities.html" class="nav-link">
                🔍 Entities
            </a>
        </div>
    </nav>
    <!-- Header -->
    <div class="header">
        <h1>📊 Test Execution Timeline</h1>
        <div class="breadcrumb">
            <a href="dashboard.html">Home</a> > Timeline Analysis
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-container">
        <div class="stat-card">
            <div class="stat-label">Total Time Span</div>
            <div class="stat-value" id="stat-timespan">-</div>
            <div class="stat-subtext">First to last test</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Total Tests Run</div>
            <div class="stat-value" id="stat-total">6</div>
            <div class="stat-subtext">Completed executions</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Average Gap</div>
            <div class="stat-value" id="stat-avg-gap">-</div>
            <div class="stat-subtext">Between tests</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Most Active Period</div>
            <div class="stat-value" id="stat-active-period">-</div>
            <div class="stat-subtext">Highest testing frequency</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Longest Gap</div>
            <div class="stat-value" id="stat-longest-gap">-</div>
            <div class="stat-subtext">Days since last test</div>
        </div>
    </div>

    <!-- Controls Panel -->
    <div class="controls-panel">
        <h3 style="margin-bottom: 15px; color: #6366f1;">Timeline Controls</h3>

        <div class="controls-row">
            <div class="control-group">
                <label class="control-label">Timeline Style</label>
                <select id="timeline-style">
                    <option value="linear">Linear Timeline (Actual Time)</option>
                    <option value="event">Event Timeline (Sequence)</option>
                    <option value="density">Density Timeline (Clusters)</option>
                </select>
            </div>

            <div class="control-group">
                <label class="control-label">Y-Axis Metric</label>
                <select id="y-metric">
                    <option value="duration">Execution Duration</option>
                    <option value="entities">Entity Count</option>
                    <option value="confidence">Average Confidence</option>
                    <option value="throughput">Throughput (ent/sec)</option>
                </select>
            </div>

            <div class="control-group">
                <label class="control-label">Strategy Filter</label>
                <select id="strategy-filter">
                    <option value="all">All Strategies</option>
                    <option value="single_pass">Single Pass</option>
                    <option value="three_wave">Three Wave</option>
                </select>
            </div>

            <div class="control-group">
                <label class="control-label">Date Range</label>
                <input type="text" id="date-range" readonly placeholder="All Dates">
            </div>
        </div>

        <div class="controls-row">
            <button onclick="resetTimeline()">🔄 Reset View</button>
            <button onclick="zoomIn()">🔍 Zoom In</button>
            <button onclick="zoomOut()">🔎 Zoom Out</button>
            <button onclick="fitToWindow()">📐 Fit to Window</button>
            <button onclick="toggleAnnotations()">🏷️ Toggle Annotations</button>
            <button onclick="exportTimeline()">💾 Export PNG</button>
            <button onclick="exportCSV()">📊 Export CSV</button>
        </div>
    </div>

    <!-- Timeline Visualization -->
    <div class="timeline-container">
        <h3 style="margin-bottom: 20px; color: #6366f1;">Interactive Timeline</h3>
        <svg id="timeline-svg" width="100%" height="400"></svg>
    </div>

    <!-- Trend Charts -->
    <div class="charts-grid">
        <div class="chart-container">
            <div class="chart-title">⏱️ Execution Time Over Time</div>
            <canvas id="chart-duration"></canvas>
        </div>

        <div class="chart-container">
            <div class="chart-title">📊 Entities Extracted Over Time</div>
            <canvas id="chart-entities"></canvas>
        </div>

        <div class="chart-container">
            <div class="chart-title">🎯 Confidence Trend</div>
            <canvas id="chart-confidence"></canvas>
        </div>

        <div class="chart-container">
            <div class="chart-title">🚀 Throughput Trend (entities/sec)</div>
            <canvas id="chart-throughput"></canvas>
        </div>

        <div class="chart-container">
            <div class="chart-title">📈 Multi-Metric Comparison</div>
            <canvas id="chart-comparison"></canvas>
        </div>

        <div class="chart-container">
            <div class="chart-title">📅 Testing Frequency Heatmap</div>
            <canvas id="chart-heatmap"></canvas>
        </div>
    </div>

    <!-- Comparison Panel -->
    <div class="comparison-panel" id="comparison-panel">
        <h3 style="margin-bottom: 15px; color: #6366f1;">Test Comparison</h3>
        <p style="color: rgba(255, 255, 255, 0.6); margin-bottom: 15px;">
            Click two tests on the timeline to compare them
        </p>
        <div class="comparison-grid" id="comparison-grid">
            <!-- Dynamically populated -->
        </div>
    </div>

    <!-- Event Log Table -->
    <div class="event-log-container">
        <h3 style="margin-bottom: 15px; color: #6366f1;">Event Log</h3>
        <table id="event-log">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>Test ID</th>
                    <th>Document</th>
                    <th>Strategy</th>
                    <th>Duration</th>
                    <th>Entities</th>
                    <th>Confidence</th>
                    <th>Throughput</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="event-log-body">
                <!-- Dynamically populated -->
            </tbody>
        </table>
    </div>

    <!-- Tooltip -->
    <div class="tooltip" id="tooltip"></div>

    <script>
        // Load test data
        const testData = {
            "version": "1.0",
            "tests": [
                {"test_id":"test_1760575089802","timestamp":1760575089.8024979,"document_id":"case_001","routing":{"strategy":"single_pass","prompt_version":"wave_v1","estimated_tokens":7655,"estimated_duration":45.03421664237976},"entity_distribution":{"total_entities":14,"unique_types":1,"avg_confidence":0.9357142857142857},"performance":{"total_duration_seconds":45.03421664237976,"entities_per_second":0.31087473134428195},"quality":{"avg_confidence_score":0.9357142857142857,"validation_passed":true}},
                {"test_id":"test_1760575126888","timestamp":1760575126.8888047,"document_id":"case_002","routing":{"strategy":"single_pass","prompt_version":"wave_v1","estimated_tokens":5945,"estimated_duration":22.525972366333008},"entity_distribution":{"total_entities":5,"unique_types":1,"avg_confidence":0.93},"performance":{"total_duration_seconds":22.525972366333008,"entities_per_second":0.22196600078729242},"quality":{"avg_confidence_score":0.93,"validation_passed":true}},
                {"test_id":"test_1760575189645","timestamp":1760575189.6457734,"document_id":"case_003","routing":{"strategy":"single_pass","prompt_version":"wave_v1","estimated_tokens":7817,"estimated_duration":48.24732255935669},"entity_distribution":{"total_entities":15,"unique_types":1,"avg_confidence":1.0},"performance":{"total_duration_seconds":48.24732255935669,"entities_per_second":0.3108980810602727},"quality":{"avg_confidence_score":1.0,"validation_passed":true}},
                {"test_id":"test_1760575343531","timestamp":1760575343.5319872,"document_id":"case_004","routing":{"strategy":"three_wave","prompt_version":"wave_v1","estimated_tokens":41973,"estimated_duration":139.50665307044983},"entity_distribution":{"total_entities":6,"unique_types":1,"avg_confidence":0.9416666666666665},"performance":{"total_duration_seconds":139.50665307044983,"entities_per_second":0.04300870150594212},"quality":{"avg_confidence_score":0.9416666666666665,"validation_passed":true}},
                {"test_id":"test_1760575386296","timestamp":1760575386.2965,"document_id":"case_005","routing":{"strategy":"single_pass","prompt_version":"wave_v1","estimated_tokens":6440,"estimated_duration":28.407291173934937},"entity_distribution":{"total_entities":6,"unique_types":1,"avg_confidence":0.9499999999999998},"performance":{"total_duration_seconds":28.407291173934937,"entities_per_second":0.21121338051075036},"quality":{"avg_confidence_score":0.9499999999999998,"validation_passed":true}},
                {"test_id":"test_1760575420481","timestamp":1760575420.481069,"document_id":"case_006","routing":{"strategy":"single_pass","prompt_version":"wave_v1","estimated_tokens":4527,"estimated_duration":20.254563331604004},"entity_distribution":{"total_entities":6,"unique_types":1,"avg_confidence":0.9516666666666667},"performance":{"total_duration_seconds":20.254563331604004,"entities_per_second":0.2962295410554697},"quality":{"avg_confidence_score":0.9516666666666667,"validation_passed":true}}
            ]
        };

        let tests = testData.tests;
        let selectedTests = [];
        let currentZoom = 1;
        let showAnnotations = true;

        // Calculate statistics
        function calculateStatistics() {
            const timestamps = tests.map(t => t.timestamp);
            const firstTest = Math.min(...timestamps);
            const lastTest = Math.max(...timestamps);
            const timespan = lastTest - firstTest;

            // Calculate gaps
            const sortedTests = [...tests].sort((a, b) => a.timestamp - b.timestamp);
            const gaps = [];
            for (let i = 1; i < sortedTests.length; i++) {
                gaps.push(sortedTests[i].timestamp - sortedTests[i-1].timestamp);
            }

            const avgGap = gaps.reduce((a, b) => a + b, 0) / gaps.length;
            const longestGap = Math.max(...gaps);

            // Update stats
            document.getElementById('stat-timespan').textContent = formatDuration(timespan);
            document.getElementById('stat-avg-gap').textContent = formatDuration(avgGap);
            document.getElementById('stat-longest-gap').textContent = formatDuration(longestGap);

            // Most active period (hour of day)
            const hours = tests.map(t => new Date(t.timestamp * 1000).getHours());
            const hourCounts = {};
            hours.forEach(h => hourCounts[h] = (hourCounts[h] || 0) + 1);
            const mostActiveHour = Object.entries(hourCounts).sort((a, b) => b[1] - a[1])[0][0];
            document.getElementById('stat-active-period').textContent = `${mostActiveHour}:00`;
        }

        function formatDuration(seconds) {
            if (seconds < 60) return `${seconds.toFixed(0)}s`;
            if (seconds < 3600) return `${(seconds / 60).toFixed(1)}m`;
            if (seconds < 86400) return `${(seconds / 3600).toFixed(1)}h`;
            return `${(seconds / 86400).toFixed(1)}d`;
        }

        function formatTimestamp(timestamp) {
            const date = new Date(timestamp * 1000);
            return date.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Build timeline
        function buildTimeline() {
            const svg = d3.select('#timeline-svg');
            const container = document.querySelector('.timeline-container');
            const width = container.clientWidth - 60;
            const height = 400;

            svg.attr('width', width).attr('height', height);
            svg.selectAll('*').remove();

            const margin = {top: 50, right: 50, bottom: 80, left: 80};
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;

            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // Get selected metric
            const yMetric = document.getElementById('y-metric').value;

            // Filter by strategy
            const strategyFilter = document.getElementById('strategy-filter').value;
            let filteredTests = tests;
            if (strategyFilter !== 'all') {
                filteredTests = tests.filter(t => t.routing.strategy === strategyFilter);
            }

            // X scale (time)
            const timestamps = filteredTests.map(t => new Date(t.timestamp * 1000));
            const xScale = d3.scaleTime()
                .domain([d3.min(timestamps), d3.max(timestamps)])
                .range([0, innerWidth]);

            // Y scale (metric)
            let yValues, yLabel;
            switch(yMetric) {
                case 'duration':
                    yValues = filteredTests.map(t => t.performance.total_duration_seconds);
                    yLabel = 'Duration (seconds)';
                    break;
                case 'entities':
                    yValues = filteredTests.map(t => t.entity_distribution.total_entities);
                    yLabel = 'Entity Count';
                    break;
                case 'confidence':
                    yValues = filteredTests.map(t => t.quality.avg_confidence_score);
                    yLabel = 'Confidence Score';
                    break;
                case 'throughput':
                    yValues = filteredTests.map(t => t.performance.entities_per_second);
                    yLabel = 'Throughput (ent/sec)';
                    break;
            }

            const yScale = d3.scaleLinear()
                .domain([0, d3.max(yValues) * 1.1])
                .range([innerHeight, 0]);

            // Grid
            g.append('g')
                .attr('class', 'grid')
                .call(d3.axisLeft(yScale)
                    .tickSize(-innerWidth)
                    .tickFormat('')
                );

            // Axes
            const xAxis = d3.axisBottom(xScale)
                .ticks(8)
                .tickFormat(d3.timeFormat('%b %d, %H:%M'));

            const yAxis = d3.axisLeft(yScale);

            g.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${innerHeight})`)
                .call(xAxis)
                .selectAll('text')
                .attr('transform', 'rotate(-45)')
                .style('text-anchor', 'end');

            g.append('g')
                .attr('class', 'axis')
                .call(yAxis);

            // Y-axis label
            g.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('x', -innerHeight / 2)
                .attr('y', -60)
                .attr('text-anchor', 'middle')
                .style('fill', 'rgba(255, 255, 255, 0.7)')
                .style('font-size', '12px')
                .text(yLabel);

            // Line
            const line = d3.line()
                .x((d, i) => xScale(new Date(filteredTests[i].timestamp * 1000)))
                .y((d) => yScale(d))
                .curve(d3.curveMonotoneX);

            g.append('path')
                .datum(yValues)
                .attr('fill', 'none')
                .attr('stroke', '#6366f1')
                .attr('stroke-width', 3)
                .attr('d', line)
                .style('opacity', 0.6);

            // Markers
            const sizeScale = d3.scaleSqrt()
                .domain([0, d3.max(filteredTests.map(t => t.entity_distribution.total_entities))])
                .range([5, 20]);

            const colorScale = d3.scaleLinear()
                .domain([0, d3.max(filteredTests.map(t => t.performance.total_duration_seconds))])
                .range(['#4ade80', '#f87171']);

            filteredTests.forEach((test, i) => {
                const cx = xScale(new Date(test.timestamp * 1000));
                const cy = yScale(yValues[i]);

                g.append('circle')
                    .attr('class', 'timeline-marker')
                    .attr('cx', cx)
                    .attr('cy', cy)
                    .attr('r', sizeScale(test.entity_distribution.total_entities))
                    .attr('fill', colorScale(test.performance.total_duration_seconds))
                    .attr('stroke', '#ffffff')
                    .attr('stroke-width', 2)
                    .attr('opacity', 0.8)
                    .on('mouseover', function(event) {
                        showTooltip(event, test);
                    })
                    .on('mouseout', hideTooltip)
                    .on('click', function() {
                        selectTest(test, this);
                    });

                // Label
                g.append('text')
                    .attr('x', cx)
                    .attr('y', cy - sizeScale(test.entity_distribution.total_entities) - 8)
                    .attr('text-anchor', 'middle')
                    .style('fill', 'rgba(255, 255, 255, 0.8)')
                    .style('font-size', '11px')
                    .style('font-weight', '600')
                    .text(test.test_id.split('_')[1].slice(-4));
            });

            // Annotations
            if (showAnnotations) {
                // Strategy change annotation
                const threeWaveTests = filteredTests.filter(t => t.routing.strategy === 'three_wave');
                if (threeWaveTests.length > 0) {
                    const firstThreeWave = threeWaveTests[0];
                    const ax = xScale(new Date(firstThreeWave.timestamp * 1000));

                    g.append('line')
                        .attr('class', 'annotation-line')
                        .attr('x1', ax)
                        .attr('y1', 0)
                        .attr('x2', ax)
                        .attr('y2', innerHeight);

                    g.append('text')
                        .attr('class', 'annotation-text')
                        .attr('x', ax + 5)
                        .attr('y', 15)
                        .text('Strategy: three_wave');
                }
            }
        }

        function showTooltip(event, test) {
            const tooltip = document.getElementById('tooltip');
            tooltip.innerHTML = `
                <div class="tooltip-title">${test.test_id}</div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Timestamp:</span>
                    <span class="tooltip-value">${formatTimestamp(test.timestamp)}</span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Document:</span>
                    <span class="tooltip-value">${test.document_id}</span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Strategy:</span>
                    <span class="tooltip-value">${test.routing.strategy}</span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Duration:</span>
                    <span class="tooltip-value">${test.performance.total_duration_seconds.toFixed(2)}s</span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Entities:</span>
                    <span class="tooltip-value">${test.entity_distribution.total_entities}</span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Confidence:</span>
                    <span class="tooltip-value">${test.quality.avg_confidence_score.toFixed(3)}</span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Throughput:</span>
                    <span class="tooltip-value">${test.performance.entities_per_second.toFixed(2)} ent/s</span>
                </div>
            `;
            tooltip.style.left = (event.pageX + 15) + 'px';
            tooltip.style.top = (event.pageY + 15) + 'px';
            tooltip.style.opacity = 1;
        }

        function hideTooltip() {
            document.getElementById('tooltip').style.opacity = 0;
        }

        function selectTest(test, element) {
            if (selectedTests.length < 2) {
                selectedTests.push(test);
                d3.select(element).classed('selected', true);
            }

            if (selectedTests.length === 2) {
                showComparison();
            }
        }

        function showComparison() {
            const panel = document.getElementById('comparison-panel');
            const grid = document.getElementById('comparison-grid');

            const test1 = selectedTests[0];
            const test2 = selectedTests[1];

            grid.innerHTML = `
                <div class="comparison-card">
                    <h4 style="color: #6366f1; margin-bottom: 10px;">${test1.test_id}</h4>
                    <p><strong>Duration:</strong> ${test1.performance.total_duration_seconds.toFixed(2)}s</p>
                    <p><strong>Entities:</strong> ${test1.entity_distribution.total_entities}</p>
                    <p><strong>Confidence:</strong> ${test1.quality.avg_confidence_score.toFixed(3)}</p>
                    <p><strong>Throughput:</strong> ${test1.performance.entities_per_second.toFixed(2)} ent/s</p>
                    <p><strong>Strategy:</strong> ${test1.routing.strategy}</p>
                </div>
                <div class="comparison-divider">VS</div>
                <div class="comparison-card">
                    <h4 style="color: #8b5cf6; margin-bottom: 10px;">${test2.test_id}</h4>
                    <p><strong>Duration:</strong> ${test2.performance.total_duration_seconds.toFixed(2)}s</p>
                    <p><strong>Entities:</strong> ${test2.entity_distribution.total_entities}</p>
                    <p><strong>Confidence:</strong> ${test2.quality.avg_confidence_score.toFixed(3)}</p>
                    <p><strong>Throughput:</strong> ${test2.performance.entities_per_second.toFixed(2)} ent/s</p>
                    <p><strong>Strategy:</strong> ${test2.routing.strategy}</p>
                </div>
            `;

            panel.classList.add('active');
        }

        function resetTimeline() {
            selectedTests = [];
            document.getElementById('comparison-panel').classList.remove('active');
            buildTimeline();
        }

        function zoomIn() {
            currentZoom *= 1.2;
            buildTimeline();
        }

        function zoomOut() {
            currentZoom /= 1.2;
            buildTimeline();
        }

        function fitToWindow() {
            currentZoom = 1;
            buildTimeline();
        }

        function toggleAnnotations() {
            showAnnotations = !showAnnotations;
            buildTimeline();
        }

        function exportTimeline() {
            // Convert SVG to PNG
            const svg = document.getElementById('timeline-svg');
            const svgData = new XMLSerializer().serializeToString(svg);
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();

            img.onload = function() {
                canvas.width = svg.width.baseVal.value;
                canvas.height = svg.height.baseVal.value;
                ctx.drawImage(img, 0, 0);

                const a = document.createElement('a');
                a.download = 'timeline.png';
                a.href = canvas.toDataURL('image/png');
                a.click();
            };

            img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
        }

        function exportCSV() {
            let csv = 'Timestamp,Test ID,Document,Strategy,Duration,Entities,Confidence,Throughput,Status\n';
            tests.forEach(test => {
                csv += `${formatTimestamp(test.timestamp)},${test.test_id},${test.document_id},${test.routing.strategy},${test.performance.total_duration_seconds.toFixed(2)},${test.entity_distribution.total_entities},${test.quality.avg_confidence_score.toFixed(3)},${test.performance.entities_per_second.toFixed(2)},COMPLETED\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.download = 'test-timeline.csv';
            a.href = URL.createObjectURL(blob);
            a.click();
        }

        // Build event log table
        function buildEventLog() {
            const tbody = document.getElementById('event-log-body');
            tbody.innerHTML = '';

            tests.forEach(test => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatTimestamp(test.timestamp)}</td>
                    <td>${test.test_id}</td>
                    <td>${test.document_id}</td>
                    <td>${test.routing.strategy}</td>
                    <td>${test.performance.total_duration_seconds.toFixed(2)}s</td>
                    <td>${test.entity_distribution.total_entities}</td>
                    <td>${test.quality.avg_confidence_score.toFixed(3)}</td>
                    <td>${test.performance.entities_per_second.toFixed(2)}</td>
                    <td><span class="status-badge status-completed">COMPLETED</span></td>
                `;
                row.addEventListener('click', () => {
                    buildTimeline();
                    // Highlight on timeline would require more logic
                });
                tbody.appendChild(row);
            });
        }

        // Build charts
        function buildCharts() {
            const labels = tests.map(t => formatTimestamp(t.timestamp));

            // Duration chart
            new Chart(document.getElementById('chart-duration'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Execution Time (s)',
                        data: tests.map(t => t.performance.total_duration_seconds),
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            labels: { color: '#e0e0e0' }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { color: 'rgba(255, 255, 255, 0.7)' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { color: 'rgba(255, 255, 255, 0.7)' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });

            // Entities chart
            new Chart(document.getElementById('chart-entities'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Entities Extracted',
                        data: tests.map(t => t.entity_distribution.total_entities),
                        backgroundColor: '#8b5cf6',
                        borderColor: '#a78bfa',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            labels: { color: '#e0e0e0' }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { color: 'rgba(255, 255, 255, 0.7)' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { color: 'rgba(255, 255, 255, 0.7)' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });

            // Confidence chart
            new Chart(document.getElementById('chart-confidence'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Average Confidence',
                        data: tests.map(t => t.quality.avg_confidence_score),
                        borderColor: '#4ade80',
                        backgroundColor: 'rgba(74, 222, 128, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            labels: { color: '#e0e0e0' }
                        }
                    },
                    scales: {
                        y: {
                            min: 0.9,
                            max: 1.0,
                            ticks: { color: 'rgba(255, 255, 255, 0.7)' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { color: 'rgba(255, 255, 255, 0.7)' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });

            // Throughput chart
            new Chart(document.getElementById('chart-throughput'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Throughput (ent/sec)',
                        data: tests.map(t => t.performance.entities_per_second),
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            labels: { color: '#e0e0e0' }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { color: 'rgba(255, 255, 255, 0.7)' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { color: 'rgba(255, 255, 255, 0.7)' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });

            // Multi-metric comparison
            new Chart(document.getElementById('chart-comparison'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Duration (s)',
                            data: tests.map(t => t.performance.total_duration_seconds),
                            borderColor: '#6366f1',
                            yAxisID: 'y',
                            tension: 0.4
                        },
                        {
                            label: 'Entities',
                            data: tests.map(t => t.entity_distribution.total_entities),
                            borderColor: '#8b5cf6',
                            yAxisID: 'y1',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            labels: { color: '#e0e0e0' }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            ticks: { color: 'rgba(255, 255, 255, 0.7)' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            ticks: { color: 'rgba(255, 255, 255, 0.7)' },
                            grid: { display: false }
                        },
                        x: {
                            ticks: { color: 'rgba(255, 255, 255, 0.7)' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });

            // Heatmap (simplified as bar chart showing tests per hour)
            const hours = tests.map(t => new Date(t.timestamp * 1000).getHours());
            const hourCounts = Array(24).fill(0);
            hours.forEach(h => hourCounts[h]++);

            new Chart(document.getElementById('chart-heatmap'), {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                    datasets: [{
                        label: 'Tests per Hour',
                        data: hourCounts,
                        backgroundColor: '#ec4899',
                        borderColor: '#f472b6',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            labels: { color: '#e0e0e0' }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { color: 'rgba(255, 255, 255, 0.7)', stepSize: 1 },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { color: 'rgba(255, 255, 255, 0.7)' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        // Event listeners
        document.getElementById('timeline-style').addEventListener('change', buildTimeline);
        document.getElementById('y-metric').addEventListener('change', buildTimeline);
        document.getElementById('strategy-filter').addEventListener('change', buildTimeline);

        // Initialize
        calculateStatistics();
        buildTimeline();
        buildEventLog();
        buildCharts();

        // Initialize date range picker
        $(function() {
            const timestamps = tests.map(t => new Date(t.timestamp * 1000));
            $('#date-range').daterangepicker({
                startDate: moment(Math.min(...timestamps)),
                endDate: moment(Math.max(...timestamps)),
                locale: {
                    format: 'MMM DD, YYYY'
                }
            });

            $('#date-range').on('apply.daterangepicker', function(ev, picker) {
                // Filter tests by date range
                buildTimeline();
            });
        });

        // Responsive resize
        window.addEventListener('resize', () => {
            buildTimeline();
        });
    </script>
</body>
</html>
