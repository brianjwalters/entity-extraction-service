<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entity Extraction - All Entities | Luris Entity Extraction Service</title>

    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #475569;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --dark-bg: #1e293b;
            --darker-bg: #0f172a;
            --card-bg: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            padding: 1.5rem 0;
            margin-bottom: 2rem;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary-color), #3b82f6);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
        }

        .breadcrumb {
            background: transparent;
            margin-bottom: 0;
            padding: 0;
        }

        .breadcrumb-item a {
            color: var(--text-secondary);
            text-decoration: none;
            transition: color 0.3s;
        }

        .breadcrumb-item a:hover {
            color: var(--primary-color);
        }

        .breadcrumb-item.active {
            color: var(--text-primary);
        }

        .stats-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s, box-shadow 0.3s;
            height: 100%;
        }

        .stats-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }

        .stats-card .icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 1rem;
        }

        .stats-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .stats-card .label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .filter-section {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        .chart-container {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            height: 400px;
        }

        .table-container {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        table.dataTable {
            color: var(--text-primary) !important;
        }

        table.dataTable thead th {
            background: var(--darker-bg);
            color: var(--text-primary);
            border-bottom: 2px solid var(--border-color);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            padding: 1rem 0.75rem;
        }

        table.dataTable tbody td {
            border-bottom: 1px solid var(--border-color);
            padding: 0.75rem;
            vertical-align: middle;
        }

        table.dataTable tbody tr {
            transition: background-color 0.2s;
        }

        table.dataTable tbody tr:hover {
            background-color: rgba(37, 99, 235, 0.1);
        }

        .entity-badge {
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: inline-block;
        }

        .badge-PARTY { background: #3b82f6; color: white; }
        .badge-CASE_CITATION { background: #8b5cf6; color: white; }
        .badge-COURT { background: #10b981; color: white; }
        .badge-STATUTE_CITATION { background: #f59e0b; color: white; }
        .badge-STATE_STATUTE_CITATION { background: #fb923c; color: white; }
        .badge-DATE { background: #06b6d4; color: white; }
        .badge-TIME { background: #14b8a6; color: white; }
        .badge-LOCATION { background: #6366f1; color: white; }
        .badge-ATTORNEY { background: #ec4899; color: white; }
        .badge-ORGANIZATION { background: #a855f7; color: white; }
        .badge-STATE { background: #84cc16; color: white; }
        .badge-JUDGE { background: #ef4444; color: white; }
        .badge-CONSTITUTIONAL_CITATION { background: #f43f5e; color: white; }
        .badge-USC_CITATION { background: #d946ef; color: white; }
        .badge-MOTION { background: #0ea5e9; color: white; }
        .badge-MONETARY_AMOUNT { background: #22c55e; color: white; }
        .badge-ATTORNEY_FEES { background: #eab308; color: white; }
        .badge-ADDRESS { background: #64748b; color: white; }
        .badge-PHONE_NUMBER { background: #94a3b8; color: white; }
        .badge-EMAIL { background: #cbd5e1; color: #0f172a; }
        .badge-UNKNOWN { background: #475569; color: white; }

        .wave-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            background: var(--darker-bg);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .wave-badge-1 { border-color: #3b82f6; color: #3b82f6; }
        .wave-badge-2 { border-color: #8b5cf6; color: #8b5cf6; }
        .wave-badge-3 { border-color: #10b981; color: #10b981; }
        .wave-badge-4 { border-color: #f59e0b; color: #f59e0b; }

        .confidence-bar {
            width: 100%;
            height: 24px;
            background: var(--darker-bg);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #3b82f6);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
            color: white;
        }

        .entity-id {
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.75rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.2s;
        }

        .entity-id:hover {
            color: var(--primary-color);
        }

        .entity-text {
            max-width: 300px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
        }

        .entity-text mark {
            background: rgba(37, 99, 235, 0.3);
            color: var(--text-primary);
            padding: 0.125rem 0.25rem;
            border-radius: 3px;
        }

        .btn-view {
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            background: var(--primary-color);
            color: white;
            border: none;
            transition: background 0.2s;
        }

        .btn-view:hover {
            background: #1d4ed8;
        }

        .dataTables_wrapper .dataTables_filter input,
        .dataTables_wrapper .dataTables_length select {
            background: var(--darker-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.5rem;
        }

        .dataTables_wrapper .dataTables_info,
        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_filter {
            color: var(--text-secondary);
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button {
            color: var(--text-primary) !important;
            background: var(--darker-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin: 0 0.25rem;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            background: var(--primary-color);
            color: white !important;
            border-color: var(--primary-color);
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background: var(--primary-color);
            color: white !important;
            border-color: var(--primary-color);
        }

        .form-select, .form-control {
            background: var(--darker-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .form-select:focus, .form-control:focus {
            background: var(--darker-bg);
            color: var(--text-primary);
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(37, 99, 235, 0.25);
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .dt-buttons {
            margin-bottom: 1rem;
        }

        .dt-button {
            background: var(--darker-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.5rem 1rem;
            margin-right: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .dt-button:hover {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        .position-display {
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .trend-indicator {
            font-size: 0.875rem;
            margin-left: 0.5rem;
        }

        .trend-up { color: var(--success-color); }
        .trend-down { color: var(--danger-color); }

        /* Navigation Header */
        .main-nav {
            background: rgba(26, 32, 44, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid #667eea;
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .nav-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.5em;
            font-weight: bold;
            color: white;
            text-decoration: none;
        }

        .nav-logo-icon {
            font-size: 1.8em;
        }

        .nav-links {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .nav-link {
            color: #cbd5e0;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
            position: relative;
        }

        .nav-link:hover {
            color: #667eea;
        }

        .nav-link.active {
            color: #667eea;
        }

        .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            right: 0;
            height: 2px;
            background: #667eea;
        }

        .nav-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .nav-icon {
            color: #cbd5e0;
            font-size: 1.3em;
            cursor: pointer;
            transition: color 0.3s;
            padding: 8px;
        }

        .nav-icon:hover {
            color: #667eea;
        }
    </style>
</head>
<body>
    <!-- Navigation Header -->
    <nav class="main-nav">
        <div class="nav-container">
            <a href="index.html" class="nav-logo">
                <span class="nav-logo-icon">🏷️</span>
                <span>Entity Extraction Dashboard</span>
            </a>
            <div class="nav-links">
                <a href="index.html" class="nav-link">Home</a>
                <a href="entities.html" class="nav-link active">Entities</a>
                <a href="relationships.html" class="nav-link">Relationships</a>
                <a href="documents.html" class="nav-link">Documents</a>
            </div>
            <div class="nav-actions">
                <span class="nav-icon" title="Search">🔍</span>
                <span class="nav-icon" title="Settings">⚙️</span>
                <span class="nav-icon" title="Help">❓</span>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <div class="header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="logo-section">
                        <div class="logo-icon">
                            <i class="bi bi-database-fill"></i>
                        </div>
                        <div>
                            <h1 class="h3 mb-0">Entity Extraction Service</h1>
                            <p class="text-secondary mb-0">All Extracted Entities</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb justify-content-md-end mb-0">
                            <li class="breadcrumb-item"><a href="index.html"><i class="bi bi-house-fill"></i> Home</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Entities</li>
                        </ol>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Summary Cards -->
        <div class="row mb-4" id="summaryCards">
            <div class="col-md-3 mb-3">
                <div class="stats-card">
                    <div class="icon" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
                        <i class="bi bi-collection-fill"></i>
                    </div>
                    <div class="value" id="totalEntities">0</div>
                    <div class="label">Total Entities</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stats-card">
                    <div class="icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                        <i class="bi bi-tags-fill"></i>
                    </div>
                    <div class="value" id="uniqueTypes">0</div>
                    <div class="label">Unique Types</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stats-card">
                    <div class="icon" style="background: linear-gradient(135deg, #10b981, #059669);">
                        <i class="bi bi-speedometer2"></i>
                    </div>
                    <div class="value">
                        <span id="avgConfidence">0.00</span>
                        <span class="trend-indicator trend-up" id="trendIndicator">
                            <i class="bi bi-arrow-up-circle-fill"></i>
                        </span>
                    </div>
                    <div class="label">Avg Confidence</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stats-card">
                    <div class="icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                        <i class="bi bi-star-fill"></i>
                    </div>
                    <div class="value" id="mostCommonType">N/A</div>
                    <div class="label">Most Common Type</div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filter-section">
            <h5 class="mb-3"><i class="bi bi-funnel-fill"></i> Filters</h5>
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label class="form-label">Entity Type</label>
                    <select class="form-select" id="filterEntityType" multiple size="5">
                        <option value="">All Types</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Confidence Range</label>
                    <div class="d-flex gap-2 align-items-center">
                        <input type="number" class="form-control" id="filterConfidenceMin" min="0" max="1" step="0.1" value="0" placeholder="Min">
                        <span>-</span>
                        <input type="number" class="form-control" id="filterConfidenceMax" min="0" max="1" step="0.1" value="1" placeholder="Max">
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Wave Number</label>
                    <div id="waveCheckboxes">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="1" id="wave1" checked>
                            <label class="form-check-label" for="wave1">Wave 1</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="2" id="wave2" checked>
                            <label class="form-check-label" for="wave2">Wave 2</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="3" id="wave3" checked>
                            <label class="form-check-label" for="wave3">Wave 3</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="null" id="waveNull" checked>
                            <label class="form-check-label" for="waveNull">Single Pass</label>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Document ID</label>
                    <select class="form-select" id="filterDocumentId">
                        <option value="">All Documents</option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <button class="btn btn-primary" onclick="applyFilters()">
                        <i class="bi bi-funnel"></i> Apply Filters
                    </button>
                    <button class="btn btn-secondary ms-2" onclick="resetFilters()">
                        <i class="bi bi-arrow-counterclockwise"></i> Reset
                    </button>
                </div>
            </div>
        </div>

        <!-- Visualizations -->
        <div class="row mb-4">
            <div class="col-md-4 mb-3">
                <div class="chart-container">
                    <canvas id="typeDistChart"></canvas>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="chart-container">
                    <canvas id="confidenceDistChart"></canvas>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="chart-container">
                    <canvas id="waveDistChart"></canvas>
                </div>
            </div>
        </div>

        <!-- DataTable -->
        <div class="table-container">
            <h5 class="mb-3"><i class="bi bi-table"></i> Entities Data</h5>
            <div id="loadingSpinner" class="text-center py-5">
                <div class="loading-spinner"></div>
                <p class="mt-3 text-secondary">Loading entities...</p>
            </div>
            <table id="entitiesTable" class="table table-hover" style="display: none; width: 100%;">
                <thead>
                    <tr>
                        <th>Entity ID</th>
                        <th>Type</th>
                        <th>Text</th>
                        <th>Confidence</th>
                        <th>Wave</th>
                        <th>Position</th>
                        <th>Document ID</th>
                        <th>Test ID</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

    <!-- Bootstrap 5 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- DataTables -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>

    <script>
        let allEntities = [];
        let dataTable = null;
        let charts = {
            typeChart: null,
            confidenceChart: null,
            waveChart: null
        };

        // Load test history and extract entities
        async function loadEntities() {
            try {
                const response = await fetch('test_history.json');
                const data = await response.json();

                // Extract all entities from all tests
                allEntities = [];
                data.tests.forEach(test => {
                    if (test.raw_response && test.raw_response.entities) {
                        test.raw_response.entities.forEach(entity => {
                            allEntities.push({
                                ...entity,
                                test_id: test.test_id,
                                document_id: test.document_id,
                                timestamp: test.timestamp
                            });
                        });
                    }
                });

                console.log(`Loaded ${allEntities.length} entities from ${data.tests.length} tests`);

                // Update UI
                updateSummaryCards();
                populateFilters();
                initializeDataTable();
                createCharts();

                // Hide loading spinner
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('entitiesTable').style.display = 'table';

            } catch (error) {
                console.error('Error loading entities:', error);
                document.getElementById('loadingSpinner').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        Error loading entities: ${error.message}
                    </div>
                `;
            }
        }

        // Update summary cards
        function updateSummaryCards() {
            const totalEntities = allEntities.length;
            const uniqueTypes = new Set(allEntities.map(e => e.entity_type)).size;
            const avgConfidence = allEntities.reduce((sum, e) => sum + (e.confidence || 0), 0) / totalEntities;

            // Count entity types
            const typeCounts = {};
            allEntities.forEach(e => {
                typeCounts[e.entity_type] = (typeCounts[e.entity_type] || 0) + 1;
            });
            const mostCommonType = Object.entries(typeCounts)
                .sort((a, b) => b[1] - a[1])[0];

            document.getElementById('totalEntities').textContent = totalEntities;
            document.getElementById('uniqueTypes').textContent = uniqueTypes;
            document.getElementById('avgConfidence').textContent = avgConfidence.toFixed(2);
            document.getElementById('mostCommonType').textContent = mostCommonType ? mostCommonType[0] : 'N/A';
        }

        // Populate filter dropdowns
        function populateFilters() {
            // Entity types
            const types = [...new Set(allEntities.map(e => e.entity_type))].sort();
            const typeSelect = document.getElementById('filterEntityType');
            types.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                typeSelect.appendChild(option);
            });

            // Document IDs
            const docIds = [...new Set(allEntities.map(e => e.document_id))].sort();
            const docSelect = document.getElementById('filterDocumentId');
            docIds.forEach(docId => {
                const option = document.createElement('option');
                option.value = docId;
                option.textContent = docId;
                docSelect.appendChild(option);
            });
        }

        // Initialize DataTable
        function initializeDataTable() {
            const tableData = allEntities.map(entity => {
                const waveDisplay = entity.wave_number !== null && entity.wave_number !== undefined
                    ? `<span class="wave-badge wave-badge-${entity.wave_number}">Wave ${entity.wave_number}</span>`
                    : '<span class="wave-badge">Single Pass</span>';

                const confidencePercent = ((entity.confidence || 0) * 100).toFixed(0);
                const confidenceBar = `
                    <div class="confidence-bar">
                        <div class="confidence-fill" style="width: ${confidencePercent}%;">
                            ${confidencePercent}%
                        </div>
                    </div>
                `;

                const entityId = entity.id || 'N/A';
                const entityIdShort = entityId.substring(0, 12) + '...';
                const entityIdDisplay = `<span class="entity-id" onclick="copyToClipboard('${entityId}')" title="Click to copy: ${entityId}">${entityIdShort}</span>`;

                const entityText = entity.text || '';
                const entityTextShort = entityText.length > 50
                    ? entityText.substring(0, 50) + '...'
                    : entityText;
                const entityTextDisplay = `<span class="entity-text" title="${entityText}"><mark>${entityTextShort}</mark></span>`;

                const positionDisplay = `<span class="position-display">${entity.start_pos}-${entity.end_pos}</span>`;

                const typeBadge = `<span class="entity-badge badge-${entity.entity_type}">${entity.entity_type}</span>`;

                const viewButton = `<button class="btn btn-view" onclick="viewEntityDetails('${entity.id}')">
                    <i class="bi bi-eye-fill"></i> View
                </button>`;

                return [
                    entityIdDisplay,
                    typeBadge,
                    entityTextDisplay,
                    confidenceBar,
                    waveDisplay,
                    positionDisplay,
                    entity.document_id,
                    entity.test_id,
                    viewButton
                ];
            });

            dataTable = $('#entitiesTable').DataTable({
                data: tableData,
                columns: [
                    { title: 'Entity ID' },
                    { title: 'Type' },
                    { title: 'Text' },
                    { title: 'Confidence' },
                    { title: 'Wave' },
                    { title: 'Position' },
                    { title: 'Document ID' },
                    { title: 'Test ID' },
                    { title: 'Actions' }
                ],
                pageLength: 25,
                lengthMenu: [[25, 50, 100, -1], [25, 50, 100, 'All']],
                responsive: true,
                dom: 'Bfrtip',
                buttons: [
                    {
                        extend: 'csv',
                        text: '<i class="bi bi-file-earmark-spreadsheet"></i> Export CSV',
                        className: 'dt-button'
                    },
                    {
                        extend: 'excel',
                        text: '<i class="bi bi-file-earmark-excel"></i> Export Excel',
                        className: 'dt-button'
                    }
                ],
                order: [[3, 'desc']], // Sort by confidence descending
                language: {
                    search: '_INPUT_',
                    searchPlaceholder: 'Search entities...'
                }
            });
        }

        // Create charts
        function createCharts() {
            createTypeDistributionChart();
            createConfidenceDistributionChart();
            createWaveDistributionChart();
        }

        // Type distribution chart
        function createTypeDistributionChart() {
            const typeCounts = {};
            allEntities.forEach(e => {
                typeCounts[e.entity_type] = (typeCounts[e.entity_type] || 0) + 1;
            });

            const sortedTypes = Object.entries(typeCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10); // Top 10 types

            const ctx = document.getElementById('typeDistChart').getContext('2d');
            charts.typeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedTypes.map(t => t[0]),
                    datasets: [{
                        label: 'Entity Count',
                        data: sortedTypes.map(t => t[1]),
                        backgroundColor: 'rgba(37, 99, 235, 0.8)',
                        borderColor: 'rgba(37, 99, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Top 10 Entity Types',
                            color: '#f1f5f9',
                            font: { size: 16, weight: 'bold' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#334155' }
                        },
                        y: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#334155' }
                        }
                    }
                }
            });
        }

        // Confidence distribution chart
        function createConfidenceDistributionChart() {
            const bins = [0, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0];
            const binCounts = new Array(bins.length - 1).fill(0);

            allEntities.forEach(e => {
                const confidence = e.confidence || 0;
                for (let i = 0; i < bins.length - 1; i++) {
                    if (confidence >= bins[i] && confidence < bins[i + 1]) {
                        binCounts[i]++;
                        break;
                    }
                }
            });

            const ctx = document.getElementById('confidenceDistChart').getContext('2d');
            charts.confidenceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: bins.slice(0, -1).map((b, i) => `${b.toFixed(1)}-${bins[i + 1].toFixed(1)}`),
                    datasets: [{
                        label: 'Entity Count',
                        data: binCounts,
                        backgroundColor: 'rgba(16, 185, 129, 0.8)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Confidence Distribution',
                            color: '#f1f5f9',
                            font: { size: 16, weight: 'bold' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#334155' }
                        },
                        y: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#334155' }
                        }
                    }
                }
            });
        }

        // Wave distribution chart
        function createWaveDistributionChart() {
            const waveCounts = {};
            allEntities.forEach(e => {
                const wave = e.wave_number !== null && e.wave_number !== undefined
                    ? `Wave ${e.wave_number}`
                    : 'Single Pass';
                waveCounts[wave] = (waveCounts[wave] || 0) + 1;
            });

            const ctx = document.getElementById('waveDistChart').getContext('2d');
            charts.waveChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(waveCounts),
                    datasets: [{
                        data: Object.values(waveCounts),
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(245, 158, 11, 0.8)'
                        ],
                        borderColor: '#1e293b',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#f1f5f9'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Entities per Wave',
                            color: '#f1f5f9',
                            font: { size: 16, weight: 'bold' }
                        }
                    }
                }
            });
        }

        // Apply filters
        function applyFilters() {
            const selectedTypes = Array.from(document.getElementById('filterEntityType').selectedOptions).map(o => o.value);
            const minConfidence = parseFloat(document.getElementById('filterConfidenceMin').value) || 0;
            const maxConfidence = parseFloat(document.getElementById('filterConfidenceMax').value) || 1;
            const selectedWaves = Array.from(document.querySelectorAll('#waveCheckboxes input:checked')).map(cb => cb.value);
            const selectedDocId = document.getElementById('filterDocumentId').value;

            // Custom filter function
            $.fn.dataTable.ext.search.push(
                function(settings, data, dataIndex) {
                    const entity = allEntities[dataIndex];

                    // Type filter
                    if (selectedTypes.length > 0 && !selectedTypes.includes('') && !selectedTypes.includes(entity.entity_type)) {
                        return false;
                    }

                    // Confidence filter
                    if (entity.confidence < minConfidence || entity.confidence > maxConfidence) {
                        return false;
                    }

                    // Wave filter
                    const entityWave = entity.wave_number !== null && entity.wave_number !== undefined
                        ? entity.wave_number.toString()
                        : 'null';
                    if (!selectedWaves.includes(entityWave)) {
                        return false;
                    }

                    // Document ID filter
                    if (selectedDocId && entity.document_id !== selectedDocId) {
                        return false;
                    }

                    return true;
                }
            );

            dataTable.draw();
        }

        // Reset filters
        function resetFilters() {
            document.getElementById('filterEntityType').selectedIndex = -1;
            document.getElementById('filterConfidenceMin').value = 0;
            document.getElementById('filterConfidenceMax').value = 1;
            document.querySelectorAll('#waveCheckboxes input').forEach(cb => cb.checked = true);
            document.getElementById('filterDocumentId').selectedIndex = 0;

            $.fn.dataTable.ext.search.pop();
            dataTable.draw();
        }

        // Copy to clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert(`Copied to clipboard: ${text}`);
            });
        }

        // View entity details
        function viewEntityDetails(entityId) {
            window.location.href = `entity_detail.html?entity_id=${entityId}`;
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', loadEntities);
    </script>
</body>
</html>
